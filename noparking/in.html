<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link rel="manifest" href="manifest.json" />

    <title>No Parking</title>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />

    <style>
      /* #### Generated By: http://www.cufonfonts.com #### */

      @font-face {
        font-family: "Charles Wright Bold";
        font-style: normal;
        font-weight: normal;
        src: local("Charles Wright Bold"), url(CharlesWright-Bold.woff) format("woff");
      }
      .reg {
        text-transform: uppercase;
        text-align: center;
        background: linear-gradient(to bottom, #f8d038 0%, #cea616 100%);
        padding: 0.25em 1em 0.25em 1.75em;
        font-weight: bolder;
        font-size: 2em;
        border-radius: 5px;
        border: 1px solid #000;
        box-shadow: 1px 1px 1px #ddd;
        font-family: "Charles Wright Bold", sans-serif;
        color: black;
        letter-spacing: 0.2em;
      }
      .reg::placeholder {
        opacity: 0.2;
      }
      .send {
        margin: 10px 0;
        width: 100%;
      }
      .imagemap img {
        vertical-align: middle;
        border: 1px lightgray solid;
        width: 100%;
        border-radius: 4px;
        margin: 4px 0px;
      }
    </style>
  </head>
  <body>
    <script
      src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
      integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"
    ></script>

    <script type="text/javascript">
      var submitted = false;

      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("sw.js").then(function() {
          console.log("Service Worker Registered");
        });
      }

      function doUppercase() {
        const reg = document.querySelector("#regInput");
        reg.value = reg.value
          .replace(" ", "")
          .toUpperCase()
          .replace(/^(\w{4}?)\s*(\w+$)/, "$1 $2");
      }

      function selectPrayerTime() {
        console.log("i am here");
        const elem = document.getElementById("prayer-time");
        if (elem.selectedIndex !== 0) return;
        const today = new Date();
        let now = today.getHours() + today.getMinutes() / 60.0;
        const d = today.getDate() + 1;

        fetch(
          `https://script.google.com/a/macros/bilalmasjid.co.uk/s/AKfycbx32N0Mu6rh15Jj_WULEwdxGY7NKpzm7PTg8NpYy8dW-Iz5VIr9/exec?name=formatted&range=F${d}:P${d}`
        )
          .then(res => res.json())
          .then(row => {
            const [fj, , zj, , aj, , mj, , ij, , un] = row[0].map(val => {
              try {
                const [h, m] = val.split(":").map(Number);
                return h + m / 60.0;
              } catch (e) {
                return 0;
              }
            });

            if (elem.selectedIndex !== 0) return;
            const fajar = fj || un;

            let selected = 0;
            if (Math.abs(now - fajar) < 0.5) selected = 1;
            if (Math.abs(now - zj) < 1.0) selected = 2;
            if (Math.abs(now - aj) < 0.5) selected = 3;
            if (Math.abs(now - mj) < 0.5) selected = 4;
            if (Math.abs(now - ij) < 0.5) selected = 5;
            elem.selectedIndex = selected;
          });
      }
      window.onload = function(e) {
        document.getElementsByName("image-map")[0].addEventListener("click", function(e) {
          const location = document.getElementsByName("Location")[0];
          location.selectedIndex = e.target.title;
        });

        selectPrayerTime();
      };
      function adjustAreaMap(e) {
        const w = document.querySelector(".imagemap img").clientWidth;
        const map = document.querySelector(".imagemap map");
        const [W, H] = map
          .getAttribute("size")
          .split(",")
          .map(Number);
        const areas = document.querySelectorAll(".imagemap area");
        areas.forEach(a => {
          a.coords = a.coords
            .split(",")
            .map(c => Math.floor((w * Number(c)) / W))
            .join(",");
        });
      }
    </script>
    <iframe
      name="hidden_iframe"
      id="hidden_iframe"
      style="display:none;"
      onload="if(submitted)  {window.location.reload(true);}"
    ></iframe>
    <div class="container">
      <h1 class="text-center">
        No Parking
      </h1>
      <h2 class="text-center">
        <small class="text-muted">Record parking offence</small>
      </h2>
      <div class="row">
        <div class="col">
          <form
            class="form"
            action="https://script.google.com/macros/s/AKfycbwR4woLJqHWb2ZrXc51PSkNqeo1LLTQg3QlYdFun44/dev"
            target="hidden_iframe"
            method="POST"
            id="mG61Hd"
            onsubmit="submitted=true;"
            spellcheck="false"
          >
            <div class="form-group">
              <label>Reg: </label>
              <input
                id="regInput"
                class="reg form-control"
                type="text"
                name="Reg"
                value=""
                placeholder="AB12 CDE"
                required="yes"
                onkeyup="doUppercase()"
              />
            </div>
            <div class="form-group">
              <label>Location: </label>
              <select class="form-control" name="Location">
                <option selected disabled hidden value=""></option>
                <option value="(1) In front">(1) In front</option>
                <option value="(2) Opposite side">(2) Opposite side</option>
                <option value="(3) Opposite near Robbin hd Way"
                  >(3) Opposite near Robbin hd Way</option
                >
                <option value="(4) Edge of Drew Gardens">(4) Edge of Drew Gardens</option>
                <option value="(5) Corner of Horsenden Lane turn"
                  >(5) Corner of Horsenden Lane turn</option
                >
                <option value="(6) Parking Island">(6) Parking Island</option>
                <option value="(7) In flats private parking"
                  >(7) In flats private parking</option
                >
              </select>
              <div class="imagemap">
                <img
                  src="NoParkingLocationsWithDesc.png"
                  usemap="#image-map"
                  onload="adjustAreaMap()"
                />

                <map name="image-map" size="562,834">
                  <area alt="1" title="1" nohref coords="298,422,30" shape="circle" />
                  <area alt="2" title="2" nohref coords="361,411,33" shape="circle" />
                  <area alt="3" title="3" nohref coords="420,522,33" shape="circle" />
                  <area alt="4" title="4" nohref coords="259,301,31" shape="circle" />
                  <area alt="5" title="5" nohref coords="150,192,34" shape="circle" />
                  <area alt="6" title="6" nohref coords="131,125,34" shape="circle" />
                  <area alt="7" title="7" nohref coords="137,354,52" shape="circle" />
                </map>
              </div>
            </div>
            <div class="form-group">
              <label>Prayer/Time: </label>
              <select id="prayer-time" class="form-control" name="Prayer">
                <option selected disabled hidden value=""></option>
                <option value="Fajar">Fajar</option>
                <option value="Zuhur">Zuhur/Jumah</option>
                <option value="Asar">Asar</option>
                <option value="Maghrib">Maghrib</option>
                <option value="Isha">Isha</option>
              </select>
            </div>

            <div class="form-group">
              <input type="submit" class="btn btn-primary mb-2 send" value="Send" />
            </div>
          </form>
        </div>
      </div>
    </div>
  </body>
</html>
