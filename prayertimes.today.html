<html>
  <head> </head>
  <body>
    <script
      type="text/javascript"
      src="https://www.gstatic.com/charts/loader.js"
    ></script>
    <script type="text/javascript">
      var storageKey = `prayerTimes.${new Date().toISOString().slice(0, 16)}`;
      var data = JSON.parse(localStorage.getItem(storageKey));
      if (data) {
        window.onload = () => drawData(data);
      } else {
        google.charts.load("current", { packages: ["table"] });

        // Set a callback to run when the Google Visualization API is loaded.
        google.charts.setOnLoadCallback(drawGID);
      }

      function drawGID() {
        var query = "SELECT * where A=" + new Date().getDate();
        console.log({ query });
        drawQueryStringAtDiv(query, "A1:N33");
      }

      function drawQueryStringAtDiv(queryStr, range) {
        var q = encodeURIComponent(queryStr);
        var query = new google.visualization.Query(
          `https://docs.google.com/spreadsheets/d/1rcJ6dvxcOfk4pcgDGbxLSzUxCgvjImohff76eYV2YZQ/gviz/tq?gid=891232984&headers=2&tq=${q}&range=${range}`
        );
        query.send(function(response) {
          if (response.isError()) {
            alert(
              "Error in query: " +
                response.getMessage() +
                " " +
                response.getDetailedMessage()
            );
            return;
          }
          var datatable = response.getDataTable();
          var data = JSON.parse(datatable.toJSON());
          localStorage.setItem(storageKey, JSON.stringify(data));
          drawData(data);
        });
      }

      function addIshraq(json) {
        var ss = json.sunrise.split(":");
        var d = new Date();
        d.setHours(ss[0]);
        d.setMinutes(ss[1]);
        d.setMinutes(d.getMinutes() + 15);
        json.ishraq = `${"0" + d.getHours()}:${d.getMinutes()}`;
      }

      function drawData(data) {
        const timeOptions = {
          hour12: true,
          hour: "2-digit",
          minute: "2-digit"
        };
        var [
          date,
          islamicDate,
          day,
          fajarBegins,
          sunrise,
          fajarJamaat,
          dhurBegins,
          dhurJamaat,
          asarBegins,
          asarJamaat,
          maghribBegins,
          maghribJamaat,
          ishaBegins,
          ishaJamaat
        ] = data.rows[0].c
          .map(val => (val.f || val.v).trim())
          .map((time, i) => {
            var [hh, mm] = time.split(":");
            if (i > 5) {
              hh = Number(hh) + 12;
            }
            const t = new Date();
            t.setHours(hh);
            t.setMinutes(mm);
            return t.toLocaleTimeString("en-GB", timeOptions);
          });
        var ss = sunrise.split(":");
        var d = new Date();
        d.setHours(ss[0]);
        d.setMinutes(parseInt(ss[1]));
        d.setMinutes(d.getMinutes() + 15);
        console.log(ss, d);
        var ishraq = d.toLocaleTimeString("en-GB", timeOptions);
        var hijriOptions = {
          year: "numeric",
          month: "long",
          day: "numeric",
          weekday: "long"
        };
        var todaysDateStr = new Date().toLocaleDateString(
          "en-GB-u-ca-islamic",
          hijriOptions
        );
        var islamicDateStr = `${islamicDate}-${data.cols[1].label}-1440 Hj`;
        var table = `<div class="date">${todaysDateStr}</div>
          <table class="table">
            <thead>
              <tr><th>Salah</th><th>Begins</th><th>Jamaat</th></tr>
            </thead>
            <tbody>
            <tr><td>Fajar</td><td>${fajarBegins}</td><td>${fajarJamaat}</td></tr>
            <tr><td>Sunrise</td><td colspan=2>${sunrise} <span class="ishraq">(Ishraq ${ishraq})</span></td></tr>
            <tr><td>Zuhr</td><td>${dhurBegins}</td><td>${dhurJamaat}</td></tr>
            <tr><td>Asar</td><td>${asarBegins}</td><td>${asarJamaat}</td></tr>
            <tr><td>Maghrib</td><td>${maghribBegins}</td><td>${maghribJamaat}</td></tr>
            <tr><td>Isha</td><td>${ishaBegins}</td><td>${ishaJamaat}</td></tr>
            <tr><td>1st Jumah</td><td colspan=2>1:30 pm</td></tr>
            <tr><td>2nd Jumah</td><td colspan=2>2:15 pm</td></tr>
            </tbody>
          </table>
          `;
        document.getElementById("table_div").innerHTML = table;
      }
    </script>
    <style>
      thead tr {
        font-size: 12pt;
      }
      th {
        background-color: gray;
        color: white;
      }
      td {
      }
      th,
      td {
        text-align: center;
        border: 0.25px rgba(128, 128, 128, 0.5) solid;
        padding: 2px 4px;
      }
      th:first-child,
      td:first-child {
        text-align: left;
      }
      table {
        width: 100%;
        text-align: center;
        border-spacing: 0;
      }
      body {
        margin: 0;
        min-height: 152px;
        font-family: Lato, "Trebuchet MS", "Lucida Sans Unicode",
          "Lucida Grande", "Lucida Sans", sans-serif;
      }
      .ishraq {
        color: gray;
        font-size: x-small;
      }
      .date {
        text-align: center;
      }
    </style>
    <div id="table_div" class="jamaat-times"></div>
  </body>
</html>
