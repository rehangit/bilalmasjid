<html>
  <head>
    <style>
      /* :root {
        --primary: hsl(256, 58%, 20%);
        --secondary: hsl(224, 32%, 50%);
        --darker: hsl(202, 48%, 80%);
        --lighter: hsl(202, 48%, 90%);
        --border: hsl(202, 48%, 97%);
      } */
      :root {
        --hue: 170;
        --primary: hsl(var(--hue), 58%, 20%);
        --secondary: hsl(var(--hue), 32%, 50%);
        --darker: hsl(var(--hue), 48%, 80%);
        --lighter: hsl(var(--hue), 48%, 90%);
        --border: hsl(var(--hue), 48%, 97%);
      }
      .today {
        height: 100%;
        width: 100%;
      }
      .date {
        text-align: center;
        background-color: var(--primary);
        color: white;
      }
      .date.english {
        font-size: x-small;
        border-top-left-radius: 4px;
        border-top-right-radius: 4px;
        padding-top: 4px;
      }
      .date.islamic {
        font-weight: bold;
        padding-bottom: 4px;
      }
      th {
        background-color: var(--secondary);
        color: var(--lighter);
        border: 0.2px var(--primary) solid;
      }
      th,
      td {
        text-align: center;
        padding: 2px 4px;
        font-size: inherit;
      }
      tr {
        background-color: var(--darker);
      }
      th,
      td {
        border: 0.2px var(--border) solid;
      }
      tr:nth-child(even) {
        background-color: var(--lighter);
      }
      tr th:first-child,
      tr td:first-child {
        text-align: left;
        border-left: 0.2px var(--primary) solid;
      }
      tr th:last-child,
      tr td:last-child {
        border-right: 0.2px var(--primary) solid;
      }
      table {
        width: 100%;
        max-height: 80%;
        text-align: center;
        border-spacing: 0;
        font-size: inherit;
        border-collapse: collapse;
      }
      tbody {
        border: 0.2px var(--primary) solid;
      }
      body {
        margin: 0;
        font-family: Lato, "Trebuchet MS", "Lucida Sans Unicode",
          "Lucida Grande", "Lucida Sans", sans-serif;
        font-size: 10pt;
      }
      .ishraq::after {
        display: none;
        content: "ishraq: " attr(data-text);
        position: absolute;
        font-size: x-small;
      }
      .highlight {
        background-color: yellow;
        animation: color_change 1s infinite alternate;
      }
      .changing:after {
        content: "•";
        position: absolute;
        margin-top: -4px;
        margin-left: 4px;
        color: red;
        text-align: left;
      }
      .legend {
        display: none;
        background-color: var(--secondary);
        padding: 0 4px 4px;
        color: var(--secondary);
        border-bottom-left-radius: 4px;
        border-bottom-right-radius: 4px;
        line-height: 0.9;
      }
      .legend.visible {
        color: red;
        font-size: large;
      }
      .legend.visible span {
        color: var(--lighter);
        font-size: x-small;
        vertical-align: middle;
      }
      .unofficial {
        opacity: 0;
      }
      .unofficial:hover,
      .unofficial:active,
      .unofficial:focus,
      .unofficial:focus-within {
        opacity: 1;
      }
      @media only screen and (min-width: 240px) {
        body {
          font-size: 12pt;
        }
      }
      @media only screen and (min-width: 300px) {
        body {
          font-size: 14pt;
        }
        .ishraq::after {
          display: initial;
        }
        .legend {
          display: block;
        }
      }
      @media only screen and (min-width: 360px) {
        body {
          font-size: 16pt;
        }
      }
      @keyframes color_change {
        from {
          background-color: yellow;
        }
        to {
          background-color: greenyellow;
        }
      }
    </style>
  </head>
  <body>
    <script type="text/javascript">
      window.onload = () => {
        const index = new Date().getDate() + 1;
        const range = `A${index}:P${index + 1}`;

        const timeOptions = {
          hour12: false,
          hour: "numeric",
          minute: "2-digit"
        };

        function formatTime(time, incH = 0, incM = 0) {
          var split = time.replace(/[^ -~]/g, "").split(/[\:\s]/);
          var t = new Date();
          t.setHours(Number(split[0]) + incH);
          t.setMinutes(Number(split[1]) + incM);
          return t
            .toLocaleTimeString("en-GB", timeOptions)
            .replace(/[^ -~]/g, "");
        }

        var getRowData = row => {
          var [
            date,
            islamicDate,
            day,
            fajarBegins,
            sunrise,
            fajarJamaat,
            dhurBegins,
            dhurJamaat,
            asarBegins,
            asarJamaat,
            maghribBegins,
            maghribJamaat,
            ishaBegins,
            ishaJamaat,
            islamicMonthNumber,
            unofficial
          ] = row.map((val, i) => {
            var [hh, mm] = val.split(":");
            if (mm) {
              const t = new Date();
              const h = Number(hh);
              t.setHours(i > 5 && i < row.length - 1 && h < 12 ? h + 12 : hh);
              t.setMinutes(mm);
              val = t.toLocaleTimeString("en-GB", timeOptions);
            }
            return val;
          });
          const islamicMonthNames = [
            "Muharram",
            "Safar",
            "Rabi al-Awwal",
            "Rabi ath-Thānī",
            "Jumadi ul-Ula",
            "Jumadi ul-Akhirah",
            "Rajab",
            "Sha‘ban",
            "Ramadhan",
            "Shawwal",
            "Dhul-Qa‘dah",
            "Dhul-Hijjah"
          ];
          const islamicMonth = islamicMonthNames[islamicMonthNumber - 1];
          return {
            date,
            islamicDate,
            day,
            fajarBegins,
            sunrise,
            fajarJamaat,
            dhurBegins,
            dhurJamaat,
            asarBegins,
            asarJamaat,
            maghribBegins,
            maghribJamaat,
            ishaBegins,
            ishaJamaat,
            islamicMonth,
            unofficial
          };
        };

        function drawData(data, cached) {
          var today = getRowData(data[0]);
          var tomorrow = getRowData(data[1] || data[0]);
          var ishraq = formatTime(today.sunrise, 0, 15);
          var todaysDateStr = `${new Date().toLocaleDateString("en-GB", {
            day: "numeric",
            year: "numeric",
            month: "long",
            hour: "2-digit",
            minute: "2-digit"
            // second: "2-digit"
          })}`;
          var islamicDateStr = `${today.islamicDate} ${today.islamicMonth} 1440 Hj`;
          var timeToMins = t => {
            const [h, m] = t
              .replace(/[^ -~]/g, "")
              .split(":")
              .map(Number);
            return h * 60 + m;
          };

          var calcStyles = (begins, jamaat, before = 0, after = 0, next) => {
            const style = [];
            var now = timeToMins(
              new Date().toLocaleTimeString("en-GB", timeOptions).slice(0, 5)
            );
            var from = timeToMins(begins) - before;
            var jamaatTime = timeToMins(jamaat);
            var to = jamaatTime + after;
            style.push(from <= now && now < to ? "highlight" : "");
            if (next && jamaatTime !== timeToMins(next)) style.push("changing");
            return style.join(" ");
          };

          // highlight which jamaat time it is now
          var [sehriClass, dhuhurClass, asarClass, maghribClass, ishaClass] = [
            calcStyles(today.fajarBegins, today.fajarBegins, 30, 0),
            calcStyles(today.dhurBegins, today.dhurJamaat, 0, 10),
            calcStyles(
              today.asarBegins,
              today.asarJamaat,
              0,
              10,
              tomorrow.asarJamaat
            ),
            calcStyles(today.maghribBegins, today.maghribBegins, 10, 10),
            calcStyles(
              today.ishaBegins,
              today.ishaJamaat,
              0,
              10,
              tomorrow.ishaJamaat
            )
          ];
          var legendClass =
            asarClass.includes("changing") || ishaClass.includes("changing")
              ? "visible"
              : "";
          var table = `
          <div class="date english">${todaysDateStr}</div>
          <div class="date islamic">${islamicDateStr}</div>
          <table class="table">
            <thead>
              <tr><th>Salah</th><th>Begins</th><th>Jamaat</th></tr>
            </thead>
            <tbody>
              <tr>
                <td>Fajar</td>
                <td class="${sehriClass}">${today.fajarBegins}</td>
                <td>
                  <span class="fajarJamaat">${today.fajarJamaat}</span>
                  <span class="unofficial">${today.unofficial}</span>
                </td>
              </tr>
              <tr>
                <td>Sunrise</td>
                <td colspan=2
                    data-text="${ishraq}"
                    class="ishraq"
                >
                  ${today.sunrise}
                </td>
              </tr>
              <tr>
                <td>Zuhr</td>
                <td>${today.dhurBegins}</td>
                <td class="${dhuhurClass}">${today.dhurJamaat}</td>
              </tr>
              <tr>
                <td>Asar</td>
                <td>${today.asarBegins}</td>
                <td class="${asarClass}">${today.asarJamaat}</td>
              </tr>
              <tr>
                <td>Maghrib</td>
                <td colspan=2 class="${maghribClass}">${today.maghribBegins}</td>
              </tr>
              <tr>
                <td>Isha</td>
                <td>${today.ishaBegins}</td>
                <td class="${ishaClass}">${today.ishaJamaat}</td></tr>
              <tr>
                <td>1st Jumah</td><td colspan=2>13:30</td>
              </tr>
              <tr>
                <td>2nd Jumah</td><td colspan=2>14:15</td>
              </tr>
            </tbody>
          </table>
          <div class="legend ${legendClass}">• <span>Changing tomorrow</span></div>
          `;
          const table_div = document.getElementById("table_div");
          table_div.innerHTML = table;
          table_div.style.opacity = cached ? 0.5 : 1.0;
        }

        const storedData = JSON.parse(
          window.localStorage.getItem("todays-times")
        );
        const dateString = new Date().toLocaleDateString();
        console.log(storedData, dateString);
        if (storedData && storedData.dateString === dateString) {
          drawData(storedData.data, true);
        }

        fetch(
          `https://script.google.com/a/macros/bilalmasjid.co.uk/s/AKfycbx32N0Mu6rh15Jj_WULEwdxGY7NKpzm7PTg8NpYy8dW-Iz5VIr9/exec?name=formatted&range=${range}`
        )
          .then(res => res.json())
          .then(data => {
            drawData(data);
            window.localStorage.setItem(
              "todays-times",
              JSON.stringify({
                data,
                dateString
              })
            );
            window.setInterval(() => drawData(data), 1000 * 30);
          });
      };
    </script>
    <div id="table_div" class="today"></div>
  </body>
</html>
