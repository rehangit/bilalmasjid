<html>
  <head>
    <style>
      :root {
        --primary: hsl(256, 58%, 20%);
        --secondary: hsl(256, 32%, 50%);
        --darker: hsl(202, 48%, 80%);
        --lighter: hsl(202, 48%, 90%);
        --border: hsl(202, 48%, 97%);
      }
      .today {
        height: 100%;
        width: 100%;
      }
      .date {
        text-align: center;
        background-color: var(--primary);
        color: white;
      }
      .date.english {
        font-size: x-small;
        border-top-left-radius: 4px;
        border-top-right-radius: 4px;
        padding-top: 4px;
      }
      .date.islamic {
        font-weight: bold;
        padding-bottom: 4px;
      }
      th {
        background-color: var(--secondary);
        color: var(--lighter);
        border: 0.2px var(--primary) solid;
      }
      th,
      td {
        text-align: center;
        padding: 2px 4px;
        font-size: inherit;
      }
      tr {
        background-color: var(--darker);
      }
      td {
        border: 0.2px var(--border) solid;
      }
      tr:nth-child(even) {
        background-color: var(--lighter);
      }
      tr th:first-child,
      tr td:first-child {
        text-align: left;
        border-left: 0.2px var(--primary) solid;
      }
      tr th:last-child,
      tr td:last-child {
        border-right: 0.2px var(--primary) solid;
      }
      table {
        width: 100%;
        max-height: 80%;
        text-align: center;
        border-spacing: 0;
        font-size: inherit;
        border-collapse: collapse;
      }
      tbody {
        border: 0.2px var(--primary) solid;
      }
      body {
        margin: 0;
        font-family: Lato, "Trebuchet MS", "Lucida Sans Unicode",
          "Lucida Grande", "Lucida Sans", sans-serif;
        font-size: 10pt;
      }
      .ishraq::after {
        display: none;
        content: "ishraq: " attr(data-text);
        position: absolute;
        font-size: x-small;
      }
      .highlight {
        background-color: yellow;
        animation: color_change 1s infinite alternate;
      }
      .changing:after {
        content: "•";
        position: absolute;
        margin-top: -4px;
        margin-left: 4px;
        color: red;
        text-align: left;
      }
      .legend {
        display: none;
        background-color: var(--secondary);
        padding: 0 4px 4px;
        color: var(--secondary);
        border-bottom-left-radius: 4px;
        border-bottom-right-radius: 4px;
        font-size: initial;
        line-height: 0.9;
      }
      .legend.visible {
        color: var(--lighter);
      }
      .legend span {
        font-size: x-small;
        vertical-align: middle;
      }
      .unofficial {
        opacity: 0;
      }
      .unofficial:hover,
      .unofficial:active,
      .unofficial:focus,
      .unofficial:focus-within {
        opacity: 1;
      }
      @media only screen and (min-width: 240px) {
        body {
          font-size: 12pt;
        }
      }
      @media only screen and (min-width: 300px) {
        body {
          font-size: 14pt;
        }
        .ishraq::after {
          display: initial;
        }
        .legend {
          display: block;
        }
      }
      @media only screen and (min-width: 360px) {
        body {
          font-size: 16pt;
        }
      }
      @keyframes color_change {
        from {
          background-color: yellow;
        }
        to {
          background-color: greenyellow;
        }
      }
    </style>
  </head>
  <body>
    <script type="text/javascript">
      const index = new Date().getDate();
      Promise.all([
        fetch(
          "https://spreadsheets.google.com/feeds/list/1qS2o3JQ07qFkUXMBvEZVZ3E8Z_mk0jMXXhxJkQ35LR8/o1a4hmz/public/values?alt=json&max-results=2&start-index=" +
            index
        )
          .then(r => r.json())
          .then(json => {
            const data = json.feed.entry.map(e => [
              e.title.$t,
              ...e.content.$t.split(", ").map(i => i.split(": ")[1].trim())
            ]);
            return data;
          }),
        new Promise(resolve => {
          window.onload = () => resolve();
        })
      ]).then(([data]) => {
        drawData(data);
        window.setInterval(() => drawData(data), 1000 * 30);

        var hidden, visibilityChange;
        if (typeof document.hidden !== "undefined") {
          // Opera 12.10 and Firefox 18 and later support
          hidden = "hidden";
          visibilityChange = "visibilitychange";
        } else if (typeof document.msHidden !== "undefined") {
          hidden = "msHidden";
          visibilityChange = "msvisibilitychange";
        } else if (typeof document.webkitHidden !== "undefined") {
          hidden = "webkitHidden";
          visibilityChange = "webkitvisibilitychange";
        }
        function handleVisibilityChange() {
          if (!document[hidden]) {
            () => drawData(data);
          }
        }
        document.addEventListener(
          visibilityChange,
          handleVisibilityChange,
          false
        );
      });

      const timeOptions = {
        hour12: false,
        hour: "numeric",
        minute: "2-digit"
      };

      function formatTime(time, incH = 0, incM = 0) {
        var split = time.replace(/[^ -~]/g, "").split(/[\:\s]/);
        var t = new Date();
        t.setHours(Number(split[0]) + incH);
        t.setMinutes(Number(split[1]) + incM);
        return t
          .toLocaleTimeString("en-GB", timeOptions)
          .replace(/[^ -~]/g, "");
      }

      var getRowData = row => {
        var [
          date,
          islamicDate,
          day,
          fajarBegins,
          sunrise,
          fajarJamaat,
          dhurBegins,
          dhurJamaat,
          asarBegins,
          asarJamaat,
          maghribBegins,
          maghribJamaat,
          ishaBegins,
          ishaJamaat,
          islamicMonth,
          unofficial
        ] = row.map((val, i) => {
          var [hh, mm] = val.split(":");
          if (mm) {
            const t = new Date();
            const h = Number(hh);
            t.setHours(i > 5 && i < row.length - 1 && h < 12 ? h + 12 : hh);
            t.setMinutes(mm);
            val = t.toLocaleTimeString("en-GB", timeOptions);
          }
          return val;
        });
        return {
          date,
          islamicDate,
          day,
          fajarBegins,
          sunrise,
          fajarJamaat,
          dhurBegins,
          dhurJamaat,
          asarBegins,
          asarJamaat,
          maghribBegins,
          maghribJamaat,
          ishaBegins,
          ishaJamaat,
          islamicMonth,
          unofficial
        };
      };

      function drawData(data) {
        var today = getRowData(data[0]);
        var tomorrow = getRowData(data[1]);
        var ishraq = formatTime(today.sunrise, 0, 15);
        var todaysDateStr = `${today.date} ${new Date().toLocaleDateString(
          "en-GB",
          {
            year: "numeric",
            month: "long",
            hour: "2-digit",
            minute: "2-digit"
            // second: "2-digit"
          }
        )}`;
        var islamicDateStr = `${today.islamicDate} ${
          today.islamicMonth
        } 1440 Hj`;
        var timeToMins = t => {
          const [h, m] = t
            .replace(/[^ -~]/g, "")
            .split(":")
            .map(Number);
          return h * 60 + m;
        };

        var calcStyles = (begins, jamaat, before = 0, after = 0, next) => {
          const style = [];
          var now = timeToMins(
            new Date().toLocaleTimeString("en-GB", timeOptions).slice(0, 5)
          );
          var from = timeToMins(begins) - before;
          var jamaatTime = timeToMins(jamaat);
          var to = jamaatTime + after;
          style.push(from <= now && now < to ? "highlight" : "");
          if (next && jamaatTime !== timeToMins(next)) style.push("changing");
          return style.join(" ");
        };

        // highlight which jamaat time it is now
        var [fajarClass, dhuhurClass, asarClass, maghribClass, ishaClass] = [
          calcStyles(today.fajarBegins, today.sunrise),
          calcStyles(today.dhurBegins, today.dhurJamaat, 0, 10),
          calcStyles(
            today.asarBegins,
            today.asarJamaat,
            0,
            10,
            tomorrow.asarJamaat
          ),
          calcStyles(today.maghribBegins, today.maghribBegins, 10, 10),
          calcStyles(
            today.ishaBegins,
            today.ishaJamaat,
            0,
            10,
            tomorrow.ishaJamaat
          )
        ];
        var legendClass =
          asarClass.includes("changing") || ishaClass.includes("changing")
            ? "visible"
            : "";
        var table = `
          <div class="date english">${todaysDateStr}</div>
          <div class="date islamic">${islamicDateStr}</div>
          <table class="table">
            <thead>
              <tr><th>Salah</th><th>Begins</th><th>Jamaat</th></tr>
            </thead>
            <tbody>
              <tr>
                <td>Fajar</td>
                <td>${today.fajarBegins}</td>
                <td class="unofficial">
                  ${today.unofficial}
                </td>
              </tr>
              <tr>
                <td>Sunrise</td>
                <td colspan=2
                    data-text="${ishraq}"
                    class="ishraq"
                >
                  ${today.sunrise}
                </td>
              </tr>
              <tr>
                <td>Zuhr</td>
                <td>${today.dhurBegins}</td>
                <td class="${dhuhurClass}">${today.dhurJamaat}</td>
              </tr>
              <tr>
                <td>Asar</td>
                <td>${today.asarBegins}</td>
                <td class="${asarClass}">${today.asarJamaat}</td>
              </tr>
              <tr>
                <td>Maghrib</td>
                <td colspan=2 class="${maghribClass}">${
          today.maghribBegins
        }</td>
              </tr>
              <tr>
                <td>Isha</td>
                <td>${today.ishaBegins}</td>
                <td class="${ishaClass}">${today.ishaJamaat}</td></tr>
              <tr>
                <td>1st Jumah</td><td colspan=2>13:30</td>
              </tr>
              <tr>
                <td>2nd Jumah</td><td colspan=2>14:15</td>
              </tr>
            </tbody>
          </table>
          <div class="legend ${legendClass}">• <span>Changing tomorrow</span></div>
          `;
        document.getElementById("table_div").innerHTML = table;
      }
    </script>
    <div id="table_div" class="today"></div>
  </body>
</html>
